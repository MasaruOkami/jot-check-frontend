<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF v2 SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS SDKï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç”¨ UMDï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .sub-title {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .note {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    /* æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆinput[type=file] ã‚’å†…åŒ…ã™ã‚‹ labelï¼‰ */
    .file-button {
      display: block;
      width: 100%;
      text-align: center;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: #06c755;
      color: #fff;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      margin-top: 8px;
    }
    .file-button input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    img.preview {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid #eee;
    }
    .status-text {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }
    .processing {
      font-size: 12px;
      color: #0066cc;
      margin-top: 8px;
    }
    .result-title {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
    }
    .result-box {
      font-size: 12px;
      background: #fafafa;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #eee;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .btn-sub {
      width: 100%;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: #e0e0e0;
      color: #333;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</h1>
    <p class="sub-title">
      åŸææ–™åãŒå†™ã£ãŸå†™çœŸã‚’1æšé€ã‚‹ã ã‘ã§ã€ã‹ã‚“ãŸã‚“ã«ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚
    </p>

    <div class="card">
      <p class="note">
        ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€ŒåŸææ–™åã€ãŒå…¨éƒ¨å…¥ã‚‹ã‚ˆã†ã«ã€æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„ã€‚<br />
        èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ <b>5ã€œ10ç§’ã»ã©</b> ã‹ã‹ã‚Šã¾ã™ã€‚
      </p>

      <!-- æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¡ãƒ© or ç”»åƒé¸æŠï¼‰ -->
      <label class="file-button">
        ğŸ“¸ æ’®å½±ã—ã¦è§£æã‚’é–‹å§‹ã™ã‚‹
        <input
          type="file"
          id="imageInput"
          accept="image/*"
          capture="environment"
        />
      </label>

      <p id="imageInfo" class="status-text">
        ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </p>

      <!-- æ’®å½±ã—ãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <img id="previewImage" class="preview" style="display:none;" alt="preview" />

      <!-- ã€Œ5ã€œ10ç§’ãŠå¾…ã¡ãã ã•ã„ã€è¡¨ç¤º -->
      <p id="processingText" class="processing" style="display:none;">
        èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ 5ã€œ10ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™ã€‚å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„â€¦
      </p>

      <!-- OCR çµæœï¼ˆç”»é¢ä¸‹éƒ¨ï¼‰ -->
      <div id="ocrResultWrapper" style="display:none;">
        <p class="result-title">èª­ã¿å–ã£ãŸåŸææ–™ï¼ˆå…¨æ–‡ï¼‰</p>
        <pre id="ocrResult" class="result-box"></pre>
      </div>

      <button id="restartBtn" class="btn-sub" style="display:none;">
        åˆ¥ã®å†™çœŸã§ã‚‚ã†ä¸€åº¦ãŸã‚ã™
      </button>
    </div>
  </div>

  <script>
    // â˜… LIFF IDï¼ˆä»Šã¾ã§ä½¿ã£ã¦ã„ãŸã‚‚ã®ï¼‰
    const LIFF_ID = "2007053599-JEBDrOoP";

    // â˜… Supabase / OCR é–¢æ•°ã®è¨­å®šï¼ˆã“ã“ã¯æ‰‹å‹•ã§åŸ‹ã‚ã‚‹ï¼‰
    // ã‚ãªãŸã® Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ URL
    const SUPABASE_URL = "https://isslaklpblhqagwtrgfi.supabase.co";
    // ã‚ãªãŸã® anon keyï¼ˆSupabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã—ã¦ã“ã“ã«è²¼ã‚‹ï¼‰
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlzc2xha2xwYmxocWFnd3RyZ2ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTQ3OTgsImV4cCI6MjA3ODY3MDc5OH0.d1Ehg8jDjFVtC2eejGH2RGlnTDax95f8EBifJ9ZYuO8";

    // OCR Edge Functionï¼ˆSupabase Functionsï¼‰ã® URL
    // ä¾‹: https://liff.jot-check.com/functions/v1/ocr-check
    const OCR_FUNCTION_URL = "https://isslaklpblhqagwtrgfi.functions.supabase.co/ocr-check";

    // Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function main() {
      const imageInput      = document.getElementById("imageInput");
      const imageInfoEl     = document.getElementById("imageInfo");
      const previewImageEl  = document.getElementById("previewImage");
      const processingText  = document.getElementById("processingText");
      const ocrResultWrap   = document.getElementById("ocrResultWrapper");
      const ocrResultEl     = document.getElementById("ocrResult");
      const restartBtn      = document.getElementById("restartBtn");

      try {
        // â‘  LIFF åˆæœŸåŒ–
        await liff.init({ liffId: LIFF_ID });
        
        // â‘¡ æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // â‘¢ LINE ID Token & friend åˆ¤å®šã‚’å–å¾—
        const idToken = liff.getIDToken();
        const { friendFlag } = await liff.getFriendship();
        
        // â‘£ auth-line ã‚’å©ã„ã¦ Supabase ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
        const authRes = await fetch(
          "https://liff.jot-check.com/functions/v1/auth-line",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              idToken,
              friendFlag,
            }),
          }
        );
        
        if (!authRes.ok) {
          document.body.innerHTML = `
            <p style="padding:16px; text-align:center;">
              ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ LINEã®å‹ã ã¡è¿½åŠ ãŒå¿…è¦ã§ã™ã€‚
            </p>
          `;
          return;
        }
        
        const session = await authRes.json();
        console.log("[auth-line] session keys", Object.keys(session || {}));
        console.log("[auth-line] access_token head", String(session?.access_token || "").slice(0, 20));
        console.log("[auth-line] refresh_token exists", !!session?.refresh_token);

        
        // â‘¤ Supabase ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚»ãƒƒãƒˆ
        await supabase.auth.setSession({
          access_token: session.access_token,
          refresh_token: session.refresh_token,
        });
        const { data: sessData, error: sessErr } = await supabase.auth.getSession();
        console.log("[supabase] getSession error", sessErr);
        console.log("[supabase] access_token head", String(sessData?.session?.access_token || "").slice(0, 20));
        console.log("[supabase] user id", sessData?.session?.user?.id || null);

        
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;
        
        // â‘¥ ã“ã“ã§åˆã‚ã¦ Supabase ã‚’å®‰å…¨ã«ä½¿ãˆã‚‹
        console.log("âœ… LINEèªè¨¼ & Supabaseèªè¨¼ å®Œäº†");

        // ã€Œåˆ¥ã®å†™çœŸã§ã‚‚ã†ä¸€åº¦ã€
        restartBtn.onclick = () => {
          imageInput.value = "";
          imageInfoEl.textContent = "ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
          previewImageEl.style.display = "none";
          processingText.style.display = "none";
          ocrResultWrap.style.display = "none";
          restartBtn.style.display = "none";
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã®å‡¦ç†
        imageInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) return;

          // æƒ…å ±è¡¨ç¤º
          const sizeKb = Math.round(file.size / 1024);
          imageInfoEl.textContent =
            "é¸æŠã•ã‚ŒãŸç”»åƒ: " + file.name + "ï¼ˆç´„ " + sizeKb + " KBï¼‰";

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
          const blobUrl = URL.createObjectURL(file);
          previewImageEl.src = blobUrl;
          previewImageEl.style.display = "block";

          // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
          ocrResultWrap.style.display = "none";
          ocrResultEl.textContent = "";
          restartBtn.style.display = "none";

          // ã€Œ5ã€œ10ç§’ãŠå¾…ã¡ãã ã•ã„ã€ã‚’è¡¨ç¤º
          processingText.style.display = "block";

          try {
            // 1) Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒã‚±ãƒƒãƒˆ: ocr-imagesï¼‰
            const filePath =
              lineUserId + "/" + Date.now().toString() + "-" + file.name;

            const { data, error } = await supabase.storage
              .from("ocr-images")
              .upload(filePath, file);

            if (error || !data) {
              console.error("upload error", error);
              alert("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (error?.message || JSON.stringify(error)));
              processingText.style.display = "none";
              restartBtn.style.display = "block";
              return;
            }

            // 2) ocr-check Edge Function ã«è§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const { data: { session: sbSession } } = await supabase.auth.getSession();
            console.log("[before ocr-check] sbSession access head", String(sbSession?.access_token || "").slice(0, 20));
            if (!sbSession?.access_token) {
              throw new Error("sbSession.access_token is empty (Supabase session not set)");
            }

            
            const res = await fetch(OCR_FUNCTION_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + sbSession.access_token,
              },
              body: JSON.stringify({
                imagePath: data.path, // Storage ä¸Šã®ãƒ‘ã‚¹
              }),
            });
            
            const json = await res.json();
            console.log("ocr-check response", json);
            
            // ã€Œ5ã€œ10ç§’ãŠå¾…ã¡ãã ã•ã„ã€ã‚’æ¶ˆã™
            processingText.style.display = "none";
            restartBtn.style.display = "block";

            // 3) ç”»é¢ä¸‹éƒ¨ã« OCR ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
            if (json.ocrText) {
              ocrResultEl.textContent = json.ocrText;
              ocrResultWrap.style.display = "block";
            } else if (json.error) {
              ocrResultEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + json.error;
              ocrResultWrap.style.display = "block";
            } else {
              ocrResultEl.textContent = "ã†ã¾ãèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã ã‘æ’®ã‚Šç›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
              ocrResultWrap.style.display = "block";
            }
          } catch (e) {
            console.error("ocr-check error", e);
            processingText.style.display = "none";
            ocrResultEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
            ocrResultWrap.style.display = "block";
            restartBtn.style.display = "block";
          }
        });

      } catch (err) {
        console.error(err);
        alert("åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      }
    }

    main();
  </script>
</body>
</html>
