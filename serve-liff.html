<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    .container { max-width: 480px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .sub-title { font-size: 13px; color: #666; margin-bottom: 16px; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .note { font-size: 12px; color: #666; margin-top: 8px; }

    .file-button {
      display: block;
      width: 100%;
      text-align: center;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: #06c755;
      color: #fff;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      margin-top: 8px;
    }
    .file-button input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
    }

    img.preview {
      max-width: 100%; border-radius: 8px; margin-top: 12px; border: 1px solid #eee;
    }
    .status-text { font-size: 12px; color: #888; margin-top: 8px; }
    .processing { font-size: 12px; color: #0066cc; margin-top: 8px; }
    .result-title { margin-top: 16px; font-size: 13px; font-weight: 600; }
    .result-box {
      font-size: 12px; background: #fafafa; border-radius: 8px; padding: 8px;
      border: 1px solid #eee; white-space: pre-wrap; word-break: break-word;
      margin-top: 4px; max-height: 200px; overflow-y: auto;
    }
    .btn-sub {
      width: 100%; padding: 10px 16px; border-radius: 999px; border: none;
      font-size: 13px; font-weight: 500; cursor: pointer;
      background: #e0e0e0; color: #333; margin-top: 12px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç¢ºèªãƒ•ãƒ­ãƒ¼ï¼šç¢ºå®šã—ãªã„ã¨é€²ã‚ãªã„ï¼‰ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }
    .modal-overlay.is-open { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .modal-title {
      font-size: 16px; font-weight: 600; margin: 0 0 12px; padding-bottom: 8px; border-bottom: 1px solid #eee;
    }
    .modal-best {
      font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px;
    }
    .modal-input {
      width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px;
      border: 1px solid #ccc; font-size: 14px; margin-bottom: 12px;
    }
    .modal-candidates {
      list-style: none; margin: 0 0 16px; padding: 0; max-height: 120px; overflow-y: auto;
    }
    .modal-candidates li {
      padding: 8px 12px; margin-bottom: 4px; border-radius: 8px; background: #f5f5f5;
      font-size: 13px; cursor: pointer;
    }
    .modal-candidates li:hover { background: #e8e8e8; }
    .modal-candidates li.selected { background: #d4edda; border: 1px solid #28a745; }
    .modal-msg { font-size: 12px; color: #666; margin-bottom: 16px; }
    .modal-actions { display: flex; flex-direction: column; gap: 10px; }
    .modal-actions .btn-confirm { background: #06c755; color: #fff; font-weight: 600; }
    .modal-actions .btn-rescan { background: #ffc107; color: #333; }
    .modal-actions .btn-fallback { background: #e0e0e0; color: #555; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</h1>
    <p class="sub-title">ã¾ãšè¡¨é¢ï¼ˆå•†å“åãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’æ’®å½±ã—ã€è¡¨ç¤ºã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ€ãƒ«ã§å•†å“åã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚</p>

    <div class="card">
      <p class="note">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€Œå•†å“åã€ã¾ãŸã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ 5ã€œ10ç§’ã‹ã‹ã‚Šã¾ã™ã€‚</p>

      <label class="file-button">
        ğŸ“¸ æ’®å½±ã—ã¦è§£æã‚’é–‹å§‹ã™ã‚‹
        <input type="file" id="imageInput" accept="image/*" capture="environment" />
      </label>

      <p id="imageInfo" class="status-text">ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      <img id="previewImage" class="preview" style="display:none;" alt="preview" />
      <p id="processingText" class="processing" style="display:none;">èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ 5ã€œ10ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™ã€‚ãŠå¾…ã¡ãã ã•ã„â€¦</p>

      <div id="ocrResultWrapper" style="display:none;">
        <p class="result-title">èª­ã¿å–ã£ãŸå†…å®¹</p>
        <pre id="ocrResult" class="result-box"></pre>
      </div>

      <button id="restartBtn" class="btn-sub" style="display:none;">åˆ¥ã®å†™çœŸã§ã‚‚ã†ä¸€åº¦ãŸã‚ã™</button>
      <pre id="dbg" style="background:#111;color:#0f0;padding:10px;border-radius:8px;max-height:220px;overflow:auto;font-size:12px;margin-top:12px;"></pre>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¡¨é¢ã‚¹ã‚­ãƒ£ãƒ³å¾Œã®å•†å“åç¢ºèªï¼ˆç¢ºå®šã—ãªã„ã¨è£é¢ã«é€²ã‚ãªã„ï¼‰ -->
  <div id="confirmModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-box">
      <p class="modal-title">å•†å“åã®ç¢ºèª</p>
      <p class="modal-best" id="modalBestText">â€”</p>
      <input type="text" id="modalTitleInput" class="modal-input" placeholder="å•†å“åã‚’ç¢ºèªãƒ»ä¿®æ­£" />
      <p class="note">å€™è£œã‚’ã‚¿ãƒƒãƒ—ã§é¸æŠã§ãã¾ã™</p>
      <ul id="modalCandidates" class="modal-candidates"></ul>
      <p id="modalMessage" class="modal-msg"></p>
      <div class="modal-actions">
        <button type="button" id="modalBtnConfirm" class="btn-sub btn-confirm">ã“ã®å•†å“åã§ç¢ºå®š</button>
        <button type="button" id="modalBtnRescan" class="btn-sub btn-rescan">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button type="button" id="modalBtnFallback" class="btn-sub btn-fallback">è£é¢ã¸é€²ã‚€ï¼ˆè¡¨é¢ã§ç‰¹å®šã§ããªã„ï¼‰</button>
      </div>
    </div>
  </div>

  <script>
    const DBG_ID = "dbg";
    function dbg(...args) {
      console.log(...args);
      const el = document.getElementById(DBG_ID);
      if (!el) return;
      const line = args.map(a => typeof a === "string" ? a : JSON.stringify(a)).join(" ");
      el.textContent += line + "\n";
    }

    const HTML_VERSION = "2026-01-29-modal-front-back";
    const LIFF_ID = "2008945507-FfPO1rgZ";
    const SUPABASE_URL = "https://isslaklpblhqagwtrgfi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlzc2xha2xwYmxocWFnd3RyZ2ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTQ3OTgsImV4cCI6MjA3ODY3MDc5OH0.d1Ehg8jDjFVtC2eejGH2RGlnTDax95f8EBifJ9ZYuO8";
    const AUTH_LINE_URL = "https://isslaklpblhqagwtrgfi.functions.supabase.co/auth-line";
    const OCR_FUNCTION_URL = "https://isslaklpblhqagwtrgfi.functions.supabase.co/ocr-check";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let requestId = crypto.randomUUID();
    let currentStep = "front";
    let frontImagePath = null;
    let lastBarcodePreviewPayload = null;

    function showFatal(msg) {
      document.body.innerHTML = "<div style='padding:16px;font-family:sans-serif;'><h2>èªè¨¼ã‚¨ãƒ©ãƒ¼</h2><pre style='white-space:pre-wrap;background:#f5f5f5;padding:12px;border-radius:8px;'>" + msg + "</pre></div>";
    }

    function openModal() {
      const modal = document.getElementById("confirmModal");
      if (modal) {
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
      }
    }

    function closeModal() {
      const modal = document.getElementById("confirmModal");
      if (modal) {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      }
    }

    async function main() {
      dbg("HTML VERSION:", HTML_VERSION);

      const imageInput = document.getElementById("imageInput");
      const imageInfoEl = document.getElementById("imageInfo");
      const previewImageEl = document.getElementById("previewImage");
      const processingText = document.getElementById("processingText");
      const ocrResultWrap = document.getElementById("ocrResultWrapper");
      const ocrResultEl = document.getElementById("ocrResult");
      const restartBtn = document.getElementById("restartBtn");
      const modalBestText = document.getElementById("modalBestText");
      const modalTitleInput = document.getElementById("modalTitleInput");
      const modalCandidates = document.getElementById("modalCandidates");
      const modalMessage = document.getElementById("modalMessage");
      const modalBtnConfirm = document.getElementById("modalBtnConfirm");
      const modalBtnRescan = document.getElementById("modalBtnRescan");
      const modalBtnFallback = document.getElementById("modalBtnFallback");

      imageInput.disabled = true;
      imageInfoEl.textContent = "èªè¨¼ä¸­ã§ã™â€¦";

      restartBtn.onclick = () => {
        imageInput.value = "";
        imageInfoEl.textContent = "ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        previewImageEl.style.display = "none";
        processingText.style.display = "none";
        ocrResultWrap.style.display = "none";
        restartBtn.style.display = "none";
        closeModal();
        currentStep = "front";
        frontImagePath = null;
        requestId = crypto.randomUUID();
      };

      try {
        const ping = await fetch(AUTH_LINE_URL, { method: "GET" });
        dbg("PING status:", ping.status);
      } catch (e) {
        dbg("PING failed:", String(e));
        showFatal("PING failed: " + String(e));
        return;
      }

      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const idToken = liff.getIDToken();
      const { friendFlag } = await liff.getFriendship();
      let authRes;
      try {
        authRes = await fetch(AUTH_LINE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken, friendFlag }),
        });
      } catch (e) {
        showFatal("auth-line failed: " + String(e));
        return;
      }

      const authText = await authRes.text();
      if (!authRes.ok) {
        showFatal("auth-line error: " + authRes.status + "\n" + authText.slice(0, 500));
        return;
      }

      let session;
      try {
        session = JSON.parse(authText);
      } catch {
        showFatal("auth-line response is not JSON");
        return;
      }

      if (!session?.access_token || !session?.refresh_token) {
        showFatal("Missing tokens in auth response");
        return;
      }

      await supabase.auth.setSession({
        access_token: session.access_token,
        refresh_token: session.refresh_token,
      });

      const { data: check } = await supabase.auth.getSession();
      if (!check?.session?.access_token) {
        showFatal("setSession done but no access_token");
        return;
      }

      const payload = JSON.parse(atob(check.session.access_token.split(".")[1]));
      if (!payload?.sub || payload?.role === "anon") {
        showFatal("JWT not authenticated");
        return;
      }

      imageInput.disabled = false;
      imageInfoEl.textContent = "èªè¨¼OKã€‚ã¾ãšã€è¡¨é¢ï¼ˆå•†å“åãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚";

      const profile = await liff.getProfile();
      const lineUserId = profile.userId;

      function fillModalFromPreview(res) {
        lastBarcodePreviewPayload = res;
        const best = res.best_candidate || {};
        modalBestText.textContent = best.title || "ï¼ˆèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼‰";
        modalTitleInput.value = (best.title || "").trim();
        modalMessage.textContent = res.message_for_user || "å•†å“åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";

        modalCandidates.innerHTML = "";
        const list = res.candidates || [];
        list.forEach((c, i) => {
          const li = document.createElement("li");
          li.textContent = (c.title || "").trim() || "â€”";
          li.dataset.index = String(i);
          li.addEventListener("click", () => {
            modalCandidates.querySelectorAll("li").forEach(el => el.classList.remove("selected"));
            li.classList.add("selected");
            modalTitleInput.value = (c.title || "").trim();
          });
          modalCandidates.appendChild(li);
        });
      }

      modalBtnConfirm.onclick = async () => {
        const confirmedTitle = modalTitleInput.value.trim();
        if (!confirmedTitle) {
          alert("å•†å“åã‚’å…¥åŠ›ã™ã‚‹ã‹ã€å€™è£œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã€Œã“ã®å•†å“åã§ç¢ºå®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const { data: sess } = await supabase.auth.getSession();
        const accessToken = sess?.session?.access_token;
        if (!accessToken) {
          alert("èªè¨¼ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const res = await fetch(OCR_FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + accessToken },
          body: JSON.stringify({
            task: "barcode_confirm",
            request_id: requestId,
            confirmed_title: confirmedTitle,
            confirmed_category: null,
          }),
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          alert("ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ: " + (j.error || res.status));
          return;
        }
        closeModal();
        currentStep = "back";
        imageInfoEl.textContent = "å•†å“åã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚æ¬¡ã«ã€åŸææ–™åï¼ˆè£é¢ï¼‰ã€ãŒå†™ã£ãŸå†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
        dbg("CONFIRMED", confirmedTitle);
      };

      modalBtnRescan.onclick = () => {
        closeModal();
        imageInput.value = "";
        previewImageEl.style.display = "none";
        processingText.style.display = "none";
        ocrResultWrap.style.display = "none";
        imageInfoEl.textContent = "ã‚‚ã†ä¸€åº¦ã€è¡¨é¢ï¼ˆå•†å“åãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
        currentStep = "front";
      };

      modalBtnFallback.onclick = () => {
        closeModal();
        currentStep = "back";
        frontImagePath = null;
        imageInfoEl.textContent = "è¡¨é¢ã§ã¯ç‰¹å®šã—ã¾ã›ã‚“ã§ã—ãŸã€‚ã€åŸææ–™åï¼ˆè£é¢ï¼‰ã€ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
      };

      imageInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const sizeKb = Math.round(file.size / 1024);
        imageInfoEl.textContent = "é¸æŠ: " + file.name + "ï¼ˆç´„ " + sizeKb + " KBï¼‰";
        previewImageEl.src = URL.createObjectURL(file);
        previewImageEl.style.display = "block";
        ocrResultWrap.style.display = "none";
        restartBtn.style.display = "none";
        processingText.style.display = "block";

        try {
          const filePath = lineUserId + "/" + Date.now().toString() + "-" + file.name;
          const { data, error } = await supabase.storage.from("ocr-images").upload(filePath, file);
          if (error || !data) {
            throw new Error("upload failed: " + (error?.message || JSON.stringify(error)));
          }
          const uploadedPath = data.path;

          const { data: sess } = await supabase.auth.getSession();
          const accessToken = sess?.session?.access_token;
          if (!accessToken) throw new Error("no access_token");

          if (currentStep === "front") {
            const res = await fetch(OCR_FUNCTION_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: "Bearer " + accessToken },
              body: JSON.stringify({
                task: "barcode_preview",
                request_id: requestId,
                imagePath: uploadedPath,
              }),
            });
            const j = await res.json().catch(() => ({}));
            processingText.style.display = "none";
            restartBtn.style.display = "block";

            if (!res.ok || !j.ok) {
              ocrResultEl.textContent = "è¡¨é¢è§£æã§ã‚¨ãƒ©ãƒ¼: " + (j.error || res.status);
              ocrResultWrap.style.display = "block";
              return;
            }

            frontImagePath = uploadedPath;
            fillModalFromPreview(j);
            openModal();
            return;
          }

          if (currentStep === "back") {
            const body = {
              task: "ingredients_scan",
              request_id: requestId,
              imagePath: uploadedPath,
              front_image_path: frontImagePath || undefined,
            };

            const res = await fetch(OCR_FUNCTION_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: "Bearer " + accessToken },
              body: JSON.stringify(body),
            });
            const j = await res.json().catch(() => ({}));
            processingText.style.display = "none";
            restartBtn.style.display = "block";

            if (!res.ok || !j.ok) {
              ocrResultEl.textContent = "è£é¢è§£æã§ã‚¨ãƒ©ãƒ¼: " + (j.error || res.status);
              ocrResultWrap.style.display = "block";
              return;
            }

            let text = "";
            if (j.reply_text) text += j.reply_text + "\n\n";
            if (j.ingredients_text) text += "åŸææ–™:\n" + j.ingredients_text + "\n\n";
            text += "è§£æçµæœã¯LINEã«ã‚‚é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            ocrResultEl.textContent = text;
            ocrResultWrap.style.display = "block";

            currentStep = "front";
            frontImagePath = null;
            requestId = crypto.randomUUID();
            imageInfoEl.textContent = "è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚åˆ¥ã®å•†å“ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å ´åˆã¯ã€å†åº¦è¡¨é¢ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
          }
        } catch (e) {
          console.error(e);
          processingText.style.display = "none";
          ocrResultEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + String(e);
          ocrResultWrap.style.display = "block";
          restartBtn.style.display = "block";
        }
      });
    }

    main().catch((e) => {
      console.error("fatal", e);
      showFatal("fatal: " + String(e));
    });
  </script>
</body>
</html>
