<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF v2 SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS SDKï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç”¨ UMDï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .sub-title {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .note {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    /* æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆinput[type=file] ã‚’å†…åŒ…ã™ã‚‹ labelï¼‰ */
    .file-button {
      display: block;
      width: 100%;
      text-align: center;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: #06c755;
      color: #fff;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      margin-top: 8px;
    }
    .file-button input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    img.preview {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid #eee;
    }
    .status-text {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }
    .processing {
      font-size: 12px;
      color: #0066cc;
      margin-top: 8px;
    }
    .result-title {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
    }
    .result-box {
      font-size: 12px;
      background: #fafafa;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #eee;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .btn-sub {
      width: 100%;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: #e0e0e0;
      color: #333;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>åŸææ–™ãƒ©ãƒ™ãƒ« ã‹ã‚“ãŸã‚“ãƒã‚§ãƒƒã‚¯</h1>
    <p class="sub-title">
      åŸææ–™åãŒå†™ã£ãŸå†™çœŸã‚’1æšé€ã‚‹ã ã‘ã§ã€ã‹ã‚“ãŸã‚“ã«ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚
    </p>

    <div class="card">
      <p class="note">
        ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€ŒåŸææ–™åã€ãŒå…¨éƒ¨å…¥ã‚‹ã‚ˆã†ã«ã€æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„ã€‚<br />
        èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ <b>5ã€œ10ç§’ã»ã©</b> ã‹ã‹ã‚Šã¾ã™ã€‚
      </p>

      <!-- æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¡ãƒ© or ç”»åƒé¸æŠï¼‰ -->
      <label class="file-button">
        ğŸ“¸ æ’®å½±ã—ã¦è§£æã‚’é–‹å§‹ã™ã‚‹
        <input
          type="file"
          id="imageInput"
          accept="image/*"
          capture="environment"
        />
      </label>

      <p id="imageInfo" class="status-text">
        ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </p>

      <!-- æ’®å½±ã—ãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <img id="previewImage" class="preview" style="display:none;" alt="preview" />

      <!-- ã€Œ5ã€œ10ç§’ãŠå¾…ã¡ãã ã•ã„ã€è¡¨ç¤º -->
      <p id="processingText" class="processing" style="display:none;">
        èª­ã¿è¾¼ã¿ã€œè§£æã¾ã§ 5ã€œ10ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™ã€‚å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„â€¦
      </p>

      <!-- OCR çµæœï¼ˆç”»é¢ä¸‹éƒ¨ï¼‰ -->
      <div id="ocrResultWrapper" style="display:none;">
        <p class="result-title">èª­ã¿å–ã£ãŸåŸææ–™ï¼ˆå…¨æ–‡ï¼‰</p>
        <pre id="ocrResult" class="result-box"></pre>
      </div>

      <button id="restartBtn" class="btn-sub" style="display:none;">
        åˆ¥ã®å†™çœŸã§ã‚‚ã†ä¸€åº¦ãŸã‚ã™
      </button>
    </div>
  </div>

    <script>
    const HTML_VERSION = "2026-01-22-11:15-auth-lock"; // â˜…å¿…ãšå‡ºã‚‹ã‹ç¢ºèª
  
    const LIFF_ID = "2007053599-JEBDrOoP";
  
    const SUPABASE_URL = "https://isslaklpblhqagwtrgfi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlzc2xha2xwYmxocWFnd3RyZ2ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTQ3OTgsImV4cCI6MjA3ODY3MDc5OH0.d1Ehg8jDjFVtC2eejGH2RGlnTDax95f8EBifJ9ZYuO8";
  
    // âœ… ä»Šå›ã¯ Supabase Functions ç”ŸURLã«å›ºå®šï¼ˆliff.jot-check.com ã¯ä½¿ã‚ãªã„ã§åˆ‡ã‚Šåˆ†ã‘ï¼‰
    const AUTH_LINE_URL = "https://isslaklpblhqagwtrgfi.functions.supabase.co/auth-line";
    const OCR_FUNCTION_URL = "https://isslaklpblhqagwtrgfi.functions.supabase.co/ocr-check";
  
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
    function showFatal(msg) {
      document.body.innerHTML = `
        <div style="padding:16px; font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif;">
          <h2 style="margin:0 0 8px;">èªè¨¼ã‚¨ãƒ©ãƒ¼</h2>
          <pre style="white-space:pre-wrap; word-break:break-word; background:#f5f5f5; padding:12px; border-radius:8px;">${msg}</pre>
        </div>
      `;
    }
  
    async function main() {
      console.log("HTML VERSION:", HTML_VERSION);
  
      const imageInput      = document.getElementById("imageInput");
      const imageInfoEl     = document.getElementById("imageInfo");
      const previewImageEl  = document.getElementById("previewImage");
      const processingText  = document.getElementById("processingText");
      const ocrResultWrap   = document.getElementById("ocrResultWrapper");
      const ocrResultEl     = document.getElementById("ocrResult");
      const restartBtn      = document.getElementById("restartBtn");
  
      // âœ… èªè¨¼å®Œäº†ã™ã‚‹ã¾ã§æ’®å½±ã§ããªã„
      imageInput.disabled = true;
      imageInfoEl.textContent = "èªè¨¼ä¸­ã§ã™â€¦ï¼ˆæ•°ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰";
  
      // ãƒªã‚»ãƒƒãƒˆ
      restartBtn.onclick = () => {
        imageInput.value = "";
        imageInfoEl.textContent = "ã¾ã ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        previewImageEl.style.display = "none";
        processingText.style.display = "none";
        ocrResultWrap.style.display = "none";
        restartBtn.style.display = "none";
      };
  
      // â‘  LIFF init
      await liff.init({ liffId: LIFF_ID });
  
      // â‘¡ æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆã“ã“ã§ return ã™ã‚‹ã®ã§æ³¨æ„ï¼‰
      if (!liff.isLoggedIn()) {
        console.log("LIFF not logged in -> login()");
        liff.login();
        return;
      }
  
      // â‘¢ LINE token & friendFlag
      const idToken = liff.getIDToken();
      const { friendFlag } = await liff.getFriendship();
  
      console.log("STEP4 about to call auth-line:", AUTH_LINE_URL);
      console.log("idToken head:", String(idToken || "").slice(0, 12), "friendFlag:", friendFlag);
  
      // â‘£ auth-line å‘¼ã³å‡ºã—ï¼ˆã“ã“ãŒé€šã‚‰ãªã„é™ã‚Šå…ˆã«é€²ã‚ãªã„ï¼‰
      let authRes;
      try {
        authRes = await fetch(AUTH_LINE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken, friendFlag }),
        });
      } catch (e) {
        console.error("âŒ auth-line fetch failed", e);
        showFatal("auth-line fetch failed (network/CORS): " + String(e));
        return;
      }
  
      const authText = await authRes.text();
      console.log("âœ… auth-line status:", authRes.status);
      console.log("âœ… auth-line raw:", authText.slice(0, 500));
  
      if (!authRes.ok) {
        showFatal("auth-line error: status=" + authRes.status + "\n" + authText.slice(0, 800));
        return;
      }
  
      let session;
      try {
        session = JSON.parse(authText);
      } catch {
        showFatal("auth-line response is not JSON:\n" + authText.slice(0, 800));
        return;
      }
  
      if (!session?.access_token || !session?.refresh_token) {
        showFatal("auth-line JSON ok but missing tokens:\n" + JSON.stringify(session, null, 2));
        return;
      }
  
      // â‘¤ Supabase ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚»ãƒƒãƒˆ
      await supabase.auth.setSession({
        access_token: session.access_token,
        refresh_token: session.refresh_token,
      });
  
      const { data: check, error: checkErr } = await supabase.auth.getSession();
      console.log("ğŸ§ª Supabase session after setSession", check, checkErr);
  
      if (!check?.session?.access_token) {
        showFatal("setSession done but getSession has no access_token.\nerr=" + String(checkErr));
        return;
      }
  
      // âœ… JWT payload ãƒã‚§ãƒƒã‚¯ï¼ˆrole/authenticated ã¨ sub ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãšï¼‰
      const payload = JSON.parse(atob(check.session.access_token.split(".")[1]));
      console.log("ğŸ§ª access_token payload", payload);
  
      // ã“ã“ã§ anon ã®ã¾ã¾ãªã‚‰ NG
      if (!payload?.sub || payload?.role === "anon") {
        showFatal(
          "Supabase session JWT is not authenticated.\n" +
          JSON.stringify(payload, null, 2)
        );
        return;
      }
  
      // â‘¥ èªè¨¼æˆåŠŸ â†’ æ’®å½±ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
      imageInput.disabled = false;
      imageInfoEl.textContent = "èªè¨¼OKã€‚ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      console.log("âœ… LINE auth & Supabase auth completed.");
  
      // LINE userIdï¼ˆä¿å­˜ãƒ‘ã‚¹ç”¨ï¼‰
      const profile = await liff.getProfile();
      const lineUserId = profile.userId;
  
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã®å‡¦ç†
      imageInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;
  
        const sizeKb = Math.round(file.size / 1024);
        imageInfoEl.textContent = "é¸æŠã•ã‚ŒãŸç”»åƒ: " + file.name + "ï¼ˆç´„ " + sizeKb + " KBï¼‰";
  
        const blobUrl = URL.createObjectURL(file);
        previewImageEl.src = blobUrl;
        previewImageEl.style.display = "block";
  
        ocrResultWrap.style.display = "none";
        ocrResultEl.textContent = "";
        restartBtn.style.display = "none";
        processingText.style.display = "block";
  
        try {
          // Storage upload
          const filePath = lineUserId + "/" + Date.now().toString() + "-" + file.name;
  
          const { data, error } = await supabase.storage.from("ocr-images").upload(filePath, file);
          if (error || !data) {
            throw new Error("upload failed: " + (error?.message || JSON.stringify(error)));
          }
  
          // ocr-check
          const { data: sess } = await supabase.auth.getSession();
          const accessToken = sess?.session?.access_token;
          console.log("[before ocr-check] access head", String(accessToken || "").slice(0, 20));
  
          if (!accessToken) throw new Error("no access_token before ocr-check");
  
          const res = await fetch(OCR_FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + accessToken,
            },
            body: JSON.stringify({ imagePath: data.path }),
          });
  
          const j = await res.json().catch(() => ({}));
          console.log("ocr-check response", j);
  
          processingText.style.display = "none";
          restartBtn.style.display = "block";
  
          if (j.ocrText) {
            ocrResultEl.textContent = j.ocrText;
          } else if (j.error) {
            ocrResultEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + j.error;
          } else {
            ocrResultEl.textContent = "ã†ã¾ãèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
          }
          ocrResultWrap.style.display = "block";
        } catch (e) {
          console.error("ocr-check flow error", e);
          processingText.style.display = "none";
          ocrResultEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + String(e);
          ocrResultWrap.style.display = "block";
          restartBtn.style.display = "block";
        }
      });
    }
  
    main().catch((e) => {
      console.error("fatal", e);
      showFatal("fatal error: " + String(e));
    });
  </script>
</body>
</html>
